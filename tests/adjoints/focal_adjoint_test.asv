
% simple test of the adjoint method for a single focal point
% things to be aware of
% what should we initialize epsilon as?
% what kind of algorithms should we use for doing gradient descent

%% Set up the domain parameters.
L0 = 1e-6;  % length unit: microns
c0 = 3e8;
num_cells = 2;
xrange = [-1 1];  % x boundaries in L0
yrange = [-1 1];  % y boundaries in L0
L = [diff(xrange), diff(yrange)];
N = [170 250];  % [Nx Ny]
N0 = N; 
Npml = 1*[15 15];  % [Nx_pml Ny_pml]

[xrange, yrange, N, dL, Lpml] = domain_with_pml(xrange, yrange, N, Npml);  % domain is expanded to include PML
Nx = N(1); Ny = N(2);
M = prod(N);
%% set up initial epsilon
eps_r= ones(N);


%% source placement
wvlen = 0.75;
omega = 2*pi*c0/wvlen;
source_coord = [0,-0.9];
[njx, njy] = coord_to_grid(source_coord, N, xrange, yrange);
Mz = zeros(N);
Mz(njx, njy) = 1;

%% define coordinate to optimize
opt_coord = [0, 0.9];
[nox, noy] = coord_to_grid(opt_coord, N, xrange, yrange);
eta = zeros(N);
eta(nox, noy) = 1;
eta = eta(:);

%% ENTER Optimization loop
epochs = 2;

for t =1:epochs

    %% get source field
    [Ez, Hx, Hy, A, omega,b]  = ...
    solveTM(L0, wvlen, xrange, yrange, eps_r, Mz, Npml);
    u0 = Ez(:);

    %% objective
    objective_eval = conj(eta.'*u0)*(eta.'*u0);
    %% get adjoint field;
    grad_objective = -2*(eta.'*u0)*eta;
    u_adj = A\grad_objective;

    Ezu = reshape(u_adj, Nx,Ny);
    % derivative of A with respect to the parameter, which is eps_r(nox, noy);
    dA_deps = omega^2*speye(M);

    %% gradient for epsilon
    % problem... it appears I get the same value for everything...
    derivative_of_objective = full(-omega^2*real(Ez.*Ezu));

    %% update epsilon
    alpha = 1e-3;
    new_eps = eps_r-alpha*derivative_of_objective;

    figure(); visreal(new_eps, xrange, yrange);
    
end

